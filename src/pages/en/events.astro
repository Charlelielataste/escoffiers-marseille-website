---
import Layout from "@/layouts/Layout.astro";
import Hero from "@/components/Hero.astro";
import EventCard from "@/components/events/EventCard.astro";
import EventsImage from "@/assets/hero/events.jpg";

import { getAllEvents } from "@/lib/sanity-queries";
import { urlFor, type Event } from "@/lib/sanity";
import { formatDateTime } from "@/lib/date";

const events = await getAllEvents();

function groupEventsByMonth(events: Event[]) {
  const grouped = events.reduce(
    (acc, event) => {
      const date = new Date(event.date);
      const monthYear = date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
      });

      if (!acc[monthYear]) {
        acc[monthYear] = [];
      }
      acc[monthYear].push(event);

      return acc;
    },
    {} as Record<string, typeof events>
  );

  Object.keys(grouped).forEach((monthYear) => {
    grouped[monthYear].sort(
      (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
    );
  });

  const sortedGroups = Object.entries(grouped).sort(
    ([monthYearA], [monthYearB]) => {
      const dateA = new Date(grouped[monthYearA][0].date);
      const dateB = new Date(grouped[monthYearB][0].date);
      return dateB.getTime() - dateA.getTime();
    }
  );

  return sortedGroups;
}

const groupedEvents = groupEventsByMonth(events);
---

<Layout title="Events">
  <div class="relative">
    <Hero picture={EventsImage} pictureAlt="Events">
      <div class="relative z-20 text-center text-white px-4 max-w-4xl mx-auto">
        <h1 class="text-4xl md:text-7xl font-bold mb-6 text-bordered">
          Events
        </h1>
        <h2
          class="text-2xl md:text-5xl font-bold mb-8 text-primary text-bordered"
        >
          Our Actions
        </h2>
        <p
          class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto leading-relaxed text-bordered"
        >
          Discover our latest actions and upcoming culinary events
        </p>
      </div>
    </Hero>
    <div class="relative bg-white pb-10">
      <div class="h-20" id="events"></div>
      <div class="max-w-5xl mx-auto px-5">
        {
          groupedEvents.map(([monthYear, events], groupIndex) => (
            <div class="mb-12">
              <div class="text-center mb-12">
                <h2 class="sm:text-4xl text-3xl font-bold text-gray-800 mb-4">
                  {monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}
                </h2>
                <hr class="w-24 h-1 bg-primary mx-auto rounded-full" />
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-8">
                {events.map((event) => (
                  <EventCard
                    title={event.title.en}
                    slug={event.slug.en.current}
                    date={formatDateTime(new Date(event.date), "en-US")}
                    location={event.location}
                    image={urlFor(event.image).width(1200).height(800).url()}
                    description={event.intro.en}
                    locale="en"
                  />
                ))}
              </div>

              {groupIndex < groupedEvents.length - 1 && (
                <div class="flex items-center justify-center my-12">
                  <div class="flex-grow h-px bg-gray-300" />
                  <div class="mx-4">
                    <div class="w-3 h-3 bg-primary rounded-full" />
                  </div>
                  <div class="flex-grow h-px bg-gray-300" />
                </div>
              )}
            </div>
          ))
        }
      </div>
    </div>
  </div>
</Layout>

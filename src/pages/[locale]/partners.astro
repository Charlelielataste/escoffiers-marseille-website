---
import Hero from "@/components/Hero.astro";
import MembersCard from "@/components/members/MembersCard.astro";
import Layout from "@/layouts/Layout.astro";
import PartnersImage from "@/assets/hero/partners.jpg";
import { getAllPartners } from "@/lib/sanity-queries";
import { urlFor } from "@/lib/sanity";
import { Image } from "astro:assets";

export function getStaticPaths() {
  return [{ params: { locale: "fr" } }, { params: { locale: "en" } }];
}

const { locale } = Astro.params;
const typedLocale = locale as "fr" | "en";
const allPartners = await getAllPartners();

// Filtrer les membres d'honneur et les membres normaux
const honnorPartners = allPartners.filter((membre) => membre.isHonored);
const partners = allPartners.filter((membre) => !membre.isHonored);
---

<Layout>
  <div class="relative">
    <Hero picture={PartnersImage} pictureAlt="Nos Partenaires">
      <div class="relative z-20 text-center text-white px-4 max-w-4xl mx-auto">
        <h1 class="text-5xl md:text-7xl font-bold mb-6">Nos Partenaires</h1>
        <h2 class="text-3xl md:text-5xl font-bold mb-8 text-primary">
          Ils nous soutiennent
        </h2>
        <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto leading-relaxed">
          Découvrez les entreprises qui nous soutiennent dans nos projets.
        </p>
      </div>
    </Hero>
    <section class="relative px-5 sm:px-10 bg-white py-10">
        <h2 class="text-3xl md:text-5xl font-bold text-primary text-center mb-16">
          Merci à eux !
        </h2>
      <!-- Section Membres d'Honneur -->
      {
        honnorPartners.length > 0 && (
          <div class="max-w-6xl mx-auto">
            <div class="flex justify-center">
              <div class="mb-16 w-full flex flex-col gap-8">
                {honnorPartners.map((partner) => (
                  <div class="border-2 w-full border-primary/20 rounded-2xl p-4 gap-8 flex md:flex-row flex-col items-center md:items-start justify-left">
    
                    <Image
                      src={urlFor(partner.image).width(150).fit('max').url()}
                      alt={partner.name}
                      width={150}
                      height={150}
                      class="object-contain"
                    />
                  
                    <div class="flex flex-col items-start gap-3 w-full">
                      <h4 class="text-3xl font-bold text-center text-primary">
                        {partner.name}
                      </h4>
                      <p class="text-left text-gray-500">
                        {partner.description[typedLocale]}
                      </p>
                      <a href={partner.link} class="text-primary font-bold hover:text-secondary/80 transition-colors duration-300 hover:underline">Voir leur site</a>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )
      }
      <!-- Section bandeau des partenaires -->
      {
        partners.length > 0 && (
            <div class="max-w-6xl mx-auto">
              <h3 class="text-center text-3xl font-bold text-primary mb-6">
                Autres Partenaires
              </h3>
              <div
                class="partners-marquee-container overflow-hidden flex flex-row relative"
                style="
                  --pause-on-hover: paused;
                  --pause-on-click: paused;
                  --width: 100%;
                  --transform: none;
                "
              >
                <!-- Gradient overlay pour l'effet de transition -->
                <div
                  class="partners-overlay absolute h-full w-full before:pointer-events-none before:absolute before:top-0 before:right-0 before:z-[2] before:w-[20%] before:rotate-180 before:touch-none after:pointer-events-none after:absolute after:top-0 after:left-0 after:z-[2] after:w-[20%] after:touch-none"
                />
                
                <!-- Premier marquee -->
                <div
                  class="partners-marquee z-[1] flex flex-row"
                  style="
                    --play: running;
                    --direction: normal;
                    --delay: 0s;
                    --iteration-count: infinite;
                    --min-width: 100%;
                  "
                >
                  <div class="partners-initial-child-container flex flex-row items-center">
                    {
                      partners.map((partner) => (
                        <a href={partner.link} class="mx-8 w-[120px] h-24 flex items-center justify-center py-2">
                          <Image
                            src={urlFor(partner.image).width(200).fit('max').url()}
                            alt={partner.name}
                            width={200}
                            height={200}
                            class="pointer-events-none max-h-16 w-auto object-contain opacity-60 select-none hover:opacity-80 transition-opacity duration-300"
                          />
                        </a>
                      ))
                    }
                  </div>
                </div>
                
                <!-- Deuxième marquee pour la continuité -->
                <div
                  aria-hidden="true"
                  class="partners-marquee flex items-center"
                  style="
                    --play: running;
                    --direction: normal;
                    --delay: 0s;
                    --iteration-count: infinite;
                    --min-width: 100%;
                  "
                >
                  {
                    partners.map((partner) => (
                      <a href={partner.link} class="mx-8 w-[120px] h-20 flex items-center justify-center py-2">
                        <Image
                          src={urlFor(partner.image).width(200).fit('max').url()}
                          alt={partner.name}
                          width={200}
                          height={200}
                          class="pointer-events-none max-h-16 w-auto object-contain opacity-60 select-none"
                        />
                      </a>
                    ))
                  }
                </div>
              </div>
            </div>
        )
      }
    </section>
  </div>
</Layout>

<script>
  let observers: ResizeObserver[] = [];

  document.addEventListener('astro:page-load', () => {
    // Clean up existing observers
    observers.forEach((observer) => observer.disconnect());
    observers = [];

    const containers = document.querySelectorAll('.partners-marquee-container');

    containers.forEach((container) => {
      const marquee = container?.querySelector('.partners-marquee') as HTMLElement;
      const initialChildContainer = container?.querySelector('.partners-initial-child-container');

      if (!container || !marquee || !initialChildContainer) {
        console.error('Partners marquee elements not found');
      } else {
        const calculateWidth = () => {
          const containerRect = container.getBoundingClientRect();
          const marqueeRect = marquee.getBoundingClientRect();
          let containerWidth = containerRect.width;
          let marqueeWidth = marqueeRect.width;

          const marquees = container.querySelectorAll('.partners-marquee');
          marquees.forEach((m) => {
            // Vitesse plus lente pour un défilement plus lisible
            const duration = marqueeWidth / 30; // 30px par seconde
            (m as HTMLElement).style.setProperty('--duration', `${duration}s`);
          });
        };

        calculateWidth();

        const resizeObserver = new ResizeObserver(calculateWidth);
        resizeObserver.observe(container);
        resizeObserver.observe(marquee);

        // Store the observer for cleanup
        observers.push(resizeObserver);
      }
    });
  });
</script>

<style>
  .partners-marquee-container {
    width: 100%;
    transform: none;
  }

  .partners-marquee-container:hover .partners-marquee {
    animation-play-state: var(--pause-on-hover);    
  }

  .partners-marquee-container:active .partners-marquee {
    animation-play-state: var(--pause-on-click);
  }

  .partners-overlay::before,
  .partners-overlay::after {
    background: linear-gradient(to right, white, rgba(255, 255, 255, 0));
    content: '';
    height: 100%;
    width: 20%;
  }

  .partners-overlay::before {
    right: -4px;
  }

  .partners-overlay::after {
    left: -4px;
  }

  .partners-marquee {
    flex: 0 0 auto;
    animation: partners-scroll var(--duration) linear var(--delay) var(--iteration-count);
    animation-play-state: var(--play);
    animation-delay: var(--delay);
    animation-direction: var(--direction);
  }

  @keyframes partners-scroll {
    0% {
      transform: translateX(0%);
    }
    100% {
      transform: translateX(-100%);
    }
  }
</style>

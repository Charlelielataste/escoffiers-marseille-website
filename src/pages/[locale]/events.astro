---
import Layout from "@/layouts/Layout.astro";
import Hero from "@/components/Hero.astro";
import EventCard from "@/components/events/EventCard.astro";
import EventsImage from "@/assets/hero/events.png";

import { getAllEvents } from "@/lib/sanity-queries";
import { urlFor, type Event } from "@/lib/sanity";
import { formatDateTime } from "@/lib/date";
import type { Locale } from "@/lib/i18n";

export function getStaticPaths() {
  return [{ params: { locale: "fr" } }, { params: { locale: "en" } }];
}

const { locale } = Astro.params as { locale: Locale };
const events = await getAllEvents();

// Fonction pour grouper les événements par mois/année
function groupEventsByMonth(events: Event[]) {
  const grouped = events.reduce(
    (acc, event) => {
      const date = new Date(event.date);
      const monthYear = date.toLocaleDateString("fr-FR", {
        year: "numeric",
        month: "long",
      });

      if (!acc[monthYear]) {
        acc[monthYear] = [];
      }
      acc[monthYear].push(event);

      return acc;
    },
    {} as Record<string, typeof events>
  );

  // Trier les événements dans chaque groupe par date décroissante
  Object.keys(grouped).forEach((monthYear) => {
    grouped[monthYear].sort(
      (a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()
    );
  });

  // Trier les groupes par date décroissante (plus récent en premier)
  const sortedGroups = Object.entries(grouped).sort(
    ([monthYearA], [monthYearB]) => {
      const dateA = new Date(grouped[monthYearA][0].date);
      const dateB = new Date(grouped[monthYearB][0].date);
      return dateB.getTime() - dateA.getTime();
    }
  );

  return sortedGroups;
}

const groupedEvents = groupEventsByMonth(events);
---

<Layout>
  <div class="relative">
    <Hero picture={EventsImage} pictureAlt="Événements">
      <div class="relative z-20 text-center text-white px-4 max-w-4xl mx-auto">
        <h1 class="text-5xl md:text-7xl font-bold mb-6">Événements</h1>
        <h2 class="text-3xl md:text-5xl font-bold mb-8 text-primary">
          Nos Actions
        </h2>
        <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto leading-relaxed">
          Découvrez nos prochains événements bénévoles et nos soutiens pour la
          ville de Marseille
        </p>
      </div>
    </Hero>
    <div class="relative bg-white pb-10">
      <div class="h-20" id="events-filter"></div>
      <div class="max-w-5xl mx-auto px-5">
        {
          groupedEvents.map(([monthYear, events], groupIndex) => (
            <div class="mb-12">
              {/* En-tête du mois/année */}
              <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">
                  {monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}
                </h2>
                <hr class="w-24 h-1 bg-primary mx-auto rounded-full" />
              </div>

              {/* Grille des événements pour ce mois */}
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-8">
                {events.map((event) => (
                  <EventCard
                    title={event.title[locale]}
                    slug={event.slug[locale].current}
                    date={formatDateTime(new Date(event.date))}
                    location={event.location}
                    image={urlFor(event.image).width(600).height(400).url()}
                    description={event.intro[locale]}
                    locale={locale}
                  />
                ))}
              </div>

              {/* Séparateur entre les groupes (sauf pour le dernier) */}
              {groupIndex < groupedEvents.length - 1 && (
                <div class="flex items-center justify-center my-12">
                  <div class="flex-grow h-px bg-gray-300" />
                  <div class="mx-4">
                    <div class="w-3 h-3 bg-primary rounded-full" />
                  </div>
                  <div class="flex-grow h-px bg-gray-300" />
                </div>
              )}
            </div>
          ))
        }
      </div>
    </div>
  </div>
</Layout>

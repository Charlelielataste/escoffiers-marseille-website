---
import { getSettings } from "@/lib/sanity-queries";
import { fileUrl } from "@/lib/sanity";
import { cn } from "@/lib/utils";
import type { Locale } from "@/lib/i18n";

const settings = await getSettings();
const currentLocale = (Astro.currentLocale || "fr") as Locale;

if (!settings?.lastEventVideo.video) {
  return null;
}
---

<section class="relative py-10">
  <div class="max-w-6xl mx-auto px-4 flex justify-center items-center">
    {
      settings.lastEventVideo.orientation === "portrait" && (
        <div class="w-full h-[680px] relative rounded-lg hidden md:block">
          <video
            src={fileUrl(settings.lastEventVideo.video)}
            aria-label={
              currentLocale === "fr" ? "Vidéo de fond" : "Background video"
            }
            class="w-full h-[680px] object-cover rounded-lg shadow-lg blur-xs opacity-60"
            data-autoplay-mobile="false"
            autoplay
            muted
            loop
          />
          <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-96 h-[680px]">
            <video
              src={fileUrl(settings.lastEventVideo.video)}
              aria-label={
                currentLocale === "fr" ? "Vidéo de l'événement" : "Event video"
              }
              class="w-full h-[680px] object-cover video-responsive"
              data-autoplay-mobile="false"
              autoplay
              muted
              controlslist="nodownload"
              controls
              loop
            />
          </div>
        </div>
      )
    }
    <div
      class={cn(
        "relative h-[680px]",
        settings.lastEventVideo.orientation === "portrait"
          ? "w-96 block md:hidden"
          : "w-full"
      )}
    >
      <video
        src={fileUrl(settings.lastEventVideo.video)}
        aria-label={currentLocale === "fr"
          ? "Vidéo de l'événement"
          : "Event video"}
        class="w-full h-full object-cover rounded-lg shadow-lg video-responsive"
        data-autoplay-mobile="false"
        autoplay
        muted
        loop
        controlslist="nodownload"
        controls></video>
    </div>
  </div>
</section>

<style>
  .video-responsive:fullscreen {
    object-fit: contain !important;
  }

  /* WebKit (Safari, Chrome) */
  .video-responsive:-webkit-full-screen {
    object-fit: contain !important;
  }

  /* Mozilla (Firefox) */
  .video-responsive:-moz-full-screen {
    object-fit: contain !important;
  }
</style>

<script>
  function disableAutoplayOnMobile() {
    if (typeof window === "undefined") return;

    const isMobile = window.innerWidth < 768;
    const videos = document.querySelectorAll<HTMLVideoElement>(
      'video[data-autoplay-mobile="false"]'
    );

    videos.forEach((video) => {
      if (isMobile) {
        video.removeAttribute("autoplay");
        video.pause();
      } else {
        video.setAttribute("autoplay", "");
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", disableAutoplayOnMobile);
  } else {
    disableAutoplayOnMobile();
  }

  document.addEventListener("astro:page-load", disableAutoplayOnMobile);

  let resizeTimeout: ReturnType<typeof setTimeout>;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(disableAutoplayOnMobile, 100);
  });
</script>
